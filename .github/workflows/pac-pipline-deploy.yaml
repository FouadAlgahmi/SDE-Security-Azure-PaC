name: PaC Pipeline Deploy

on:
  workflow_call:
    inputs:

      environment:
        type: string
        required: true 

      pac-selector-dev:
        type: string
        required: true

      run_id:
        type: string
        required: true

      plan_folder:
        type: string
        required: false
        default: ./Output


jobs:
  review-build-plan-message:
    name: Review build plan
    runs-on: ubuntu-latest
    steps:

      - name: Show plan Output
        uses: actions/github-script@v6
        with:
          script: |
            await core.summary
              .addHeading('Review epac plan results')
              .addLink('Click this link to review the epac plan.', ${{ inputs.run_id }})
              .addBreak()
              .addRaw('On the displayed page scroll to the bottom to treview the build plan.')
              .addBreak()
              .addRaw('Then return to this page to approve or deny the Deployment of the plan.')
              .addBreak()
              .write()
  
  prepare-workspace: 
    name: Prepare workspace for deployment
    runs-on: ubuntu-latest
    needs: review-build-plan-message
    environment: ${{ inputs.envirnoment}}
    steps:

      - name: Checkout
        uses: actions/checkout@v3.3.0

      - name: Download artifact
        uses: actions/github-script@v6
        with:
          script: |
            let allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ inputs.run_id }}
              }); 
            
            console.log(context.repo.owner, context.repo.repo, ${{ inputs.run_id }}, allArtifacts.data.artifacts);
            let matchArtifact= allArtifacts.data.artifacts.filter((artifact)=> {
            return artifact.name=="Deployment-Plans"})[0];

            let download= await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: matchArtifact.id,
              archive_format: 'zip',
              });

            let fs = require('fs')
            fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/Deployment-Plans.zip`, Buffer.from(download.data));

      - name: Unzip artifacts
        shell: bash
        run: |
          mkdir -p ${{ inputs.plan_folder}}
          unzip Deployment-Plans.zip -d ${{ inputs.plan_folder }}
      
      - name: Cache the workspace
        uses: actions/cache/save@v3
        with:
          path: .
          key: ${{ runner.os }}-cache--${{ github.run_id }}

  deploy-to-dev:
    name: Deploy policy plan and roles to dev environment
    runs-on: ubuntu-latest
    needs: prepare-workspace
    steps:
      - name: restore cache
        uses: actions/cache/restore
        with:
          path: .
          key: ${{ runner.OS }}-cache--${{ github.run_id }}
          restore-keys: |
            ${{ runner.OS }}-cache-
